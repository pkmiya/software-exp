                         4 .list
                         5 **
                         6 ** Create queue of 256 bytes and enqueue data
                         7 ** enqueue_data.s
                         8 **
                         9 
                        10 .section .text
                        11 
                        12 ******************************
                        13 ** メインルーチン
                        14 ** a0:書き込むデータのアドレス
                        15 ** d4:書き込み回数
                        16 ******************************
                        17 
                        18 Start:
000400 4EBA 0020        19     jsr     Init_Q              /* キューの初期化処理 */
000404 41F9 0000        20     lea.l   Data_to_Que, %a0
       0000             20 
00040a 283C 0000        21     move.l  #257, %d4
       0101             21 
                        22 
                        23 Loop1:
000410 5344             24     subq.w  #1, %d4
000412 6500 000A        25     bcs     End_program
000416 4EBA 002E        26     jsr     In_Q                /* 書き込み処理 */
00041a 6000 FFF4        27     bra     Loop1
                        28 
                        29 End_program:
00041e 4E72 2700        30     stop    #0x2700
                        31 
                        32 **********************
                        33 ** キューの初期化処理
                        34 **********************
                        35 Init_Q:
000422 45F9 0000        36     lea.l   BF_START, %a2
       0000             36 
000428 23CA 0000        37     move.l  %a2,      PUT_PTR
       0000             37 
00042e 23CA 0000        38     move.l  %a2,      GET_PTR
       0000             38 
000434 13FC 00FF        39     move.b  #0xff,    PUT_FLG
       0000 0000        39 
00043c 13FC 0000        40     move.b  #0x00,    GET_FLG
       0000 0000        40 
000444 4E75             41     rts
                        42 
                        43 ***********************************
                        44 ** In_Q キューへのデータ書き込み
                        45 ** a0: 書き込むデータのアドレス
                        46 ** d0: 結果(00:失敗, 00以外:成功)
                        47 ***********************************
                        48 In_Q:
000446 4EBA 0004        49     jsr     PUT_BUF             /* キューへの書き込み */
00044a 4E75             50     rts
                        51 
                        52 ****************************************
                        53 ** PUT_BUF
                        54 ** a0: 書き込むデータのアドレス
                        55 ** d0: 結果(00:失敗, 00以外:成功)
                        56 ****************************************
                        57 
                        58 PUT_BUF:
00044c 48E7 0070        59     movem.l     %a1-%a3, -(%sp)
000450 1039 0000        60     move.b      PUT_FLG, %d0
       0000             60 
000456 0C00 0000        61     cmp.b       #0x00,   %d0
00045a 6700 003E        62     beq         PUT_BUF_Finish
00045e 2279 0000        63     movea.l     PUT_PTR, %a1
       0000             63 
000464 12D8             64     move.b      (%a0)+, (%a1)+
000466 47F9 0000        65     lea.l       BF_END,  %a3    /* （ア） */
       0000             65 
00046c B3CB             66     cmpa.l      %a3,     %a1    /* （ア） */
00046e 6300 000A        67     bls         PUT_BUF_STEP1   /* （ア） */
000472 45F9 0000        68     lea.l BF_START, %a2
       0000             68 
000478 224A             69     movea.l %a2, %a1
                        70 
                        71 PUT_BUF_STEP1:
00047a 23C9 0000        72     move.l      %a1, PUT_PTR    /* （イ） */
       0000             72 
000480 B3F9 0000        73     cmpa.l      GET_PTR, %a1    /* （イ） */
       0000             73 
000486 6600 000A        74     bne         PUT_BUF_STEP2   /* （イ） */
00048a 13FC 0000        75     move.b      #0x00, PUT_FLG
       0000 0000        75 
                        76 
                        77 PUT_BUF_STEP2:
000492 13FC 00FF        78     move.b #0xff, GET_FLG
       0000 0000        78 
                        79 
                        80 PUT_BUF_Finish:
00049a 4CDF 0E00        81     movem.l     (%sp)+, %a1-%a3 /* （エ） */
00049e 4E75             82     rts
                        83 
                        84 
                        85 .section .data
                        86 
                        87 ******************************
                        88 ** キュー用のメモリ領域確保
                        89 ******************************
                        90 
                        91 .equ B_SIZE, 256
0004a0 0000 0000        92 BF_START:   .ds.b B_SIZE-1      /* （ウ） */
       0000 0000        92 
       0000 0000        92 
       0000 0000        92 
       0000 0000        92 
00059f 00               93 BF_END:     .ds.b 1             /* （ウ） */
0005a0 0000 0000        94 PUT_PTR:    .ds.l 1
0005a4 0000 0000        95 GET_PTR:    .ds.l 1
0005a8 00               96 PUT_FLG:    .ds.b 1
0005a9 00               97 GET_FLG:    .ds.b 1
                        98 
                        99 ******************************
                       100 ** 書き込むデータ（サンプル）
                       101 ******************************
                       102 
0005aa 4142 43         103 Data_to_Que: .ascii "ABC"
                       104 .end
